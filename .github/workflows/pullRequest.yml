name: Pull Request Log

on: push

jobs:
  pr_log:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2

    - name: Run Shell Script
      run: |
        pr_log_name="pullrequestlog.md"
        temp_file_name="temp"
        start_datetime="2023-07-01T19:00:00Z"
        end_datetime="2023-08-01T19:00:08Z"
        base="main"
        search_query="is:pr merged:>$start_datetime merged:<$end_datetime -author:app/dependabot"

        merged_prs=$(gh pr list --base $base --search "$search_query" --json author,title,url,mergedAt --jq '.[]')

        echo "$merged_prs"

        if [ ! -f $pr_log_name ]; then
            touch $pr_log_name
        fi

        if [ -n "$merged_prs" ]; then
            echo -e "$(date +'## %Y-%m-%d (Week %V)')\n" >$temp_file_name
            counter=1
            while read -r line; do
                author=$(echo "$line" | jq -r '.author.login')
                title=$(echo "$line" | jq -r '.title')
                url=$(echo "$line" | jq -r '.url')
                echo "$counter. [$title]($url) @$author" >>$temp_file_name
                ((counter++))
            done <<<"$merged_prs"

            echo -e "" >>$temp_file_name
            cat $pr_log_name >>$temp_file_name
            mv $temp_file_name $pr_log_name
        fi
      env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Commit and Push Changes
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add pullrequestlog.md
        git commit -m "Update Pull Request Log"
        git push
      env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
